<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dropbox Photo Slideshow</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #000000;
            color: #ffffff;
        }
        #slideshow-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        #slideshow-image {
            width: 100vw;
            height: 100vh;
            object-fit: contain;
            image-rendering: optimizeQuality;
        }
        #controls {
            position: fixed;
            bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            z-index: 10;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #007ee5;
            color: white;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #1e90ff;
        }
        button:disabled {
            background-color: #666666;
            cursor: not-allowed;
        }
        #auth-message {
            position: fixed;
            top: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 5px;
            color: #ffffff;
            text-align: center;
            z-index: 10;
        }
        #folder-input {
            padding: 8px;
            font-size: 14px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: #333333;
            color: #ffffff;
            margin-bottom: 10px;
        }
        @media (max-width: 600px) {
            button, #folder-input {
                padding: 8px 16px;
                font-size: 14px;
            }
            #auth-message {
                font-size: 14px;
                padding: 8px 16px;
            }
        }
    </style>
</head>
<body>
    <div id="auth-message">Enter a Dropbox folder path (e.g., '/Photos') and click 'Connect to Dropbox' to start the slideshow</div>
    <input id="folder-input" type="text" placeholder="Enter Dropbox folder path (e.g., /Photos)" value="">
    <div id="slideshow-container">
        <img id="slideshow-image" src="" alt="Slideshow Image" style="display: none;">
    </div>
    <div id="controls">
        <button id="connect-button">Connect to Dropbox</button>
        <button id="play-pause-button" style="display: none;">Play</button>
        <button id="prev-button" style="display: none;">Previous</button>
        <button id="next-button" style="display: none;">Next</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/dropbox@10.34.0/dist/Dropbox-sdk.min.js"></script>
    <script>
        // Fallback if primary CDN fails
        if (typeof Dropbox === 'undefined') {
            document.getElementById('auth-message').textContent = 'Primary Dropbox SDK failed to load. Attempting fallback...';
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/dropbox@10.34.0/dist/Dropbox-sdk.min.js';
            script.onload = initializeApp;
            script.onerror = () => {
                document.getElementById('auth-message').textContent = 'Error: Failed to load Dropbox SDK from both sources. Check your internet or CDN availability.';
                console.error('Failed to load Dropbox SDK from both CDNs.');
                throw new Error('Dropbox SDK not loaded.');
            };
            document.head.appendChild(script);
        } else {
            initializeApp();
        }

        function initializeApp() {
            // Dropbox access token (provided by user, single-line string)
            const ACCESS_TOKEN = 'sl.u.AF6Xnj2MGovhtkHXSTX99nSXaGeD6Qbm3JOgUxND9oAoouBqO4Qynp3u9MFF8J-PhaknS9axvUtjab7XBIzxLeBjIba8EUauNSZQx4NyaniUZRgFygRnIxQe-0CDVzX0xg6XtEhgetsDVULvFnLuzloJK55cf5h5AMDlq9Nlb326OaR70K4Sg2BbmF_Ql4tYKZ9R4j8bVf2RYrPSy3qCqUx7ySmpsaMdzjYP20cCc7nsdG60fKTlQ9M2q-0N-pWKl3arJU-Vq9wRBDKu0R0yVHPBHjfDY97Uydj63f9uQ1es5-436T5YEU-ByPZpvMM785VS2YFZ9SCDcuLSyJxLfEjJ8yPZWI5eQUJ_O9LrvMeaIKsY_fKbAF1I-xxBZSfLwoBbQjFdp0X4HmwNVJVxMuV2qbfG-vyFJEpVCnB1iZhJApZit_B0-S1oXYuT75Ty-s85PA_X4Y9NcWwfg-CCBCdxiydOx7QUSSc_SHIpvv4XHyI2Bc4-9ygegXEvlkC6WMJHFmiphAg0hqlmmv8HpxurOEl69ZIg_exBNEjMmlOQiJMpiY0g0LvhStxr2iDwiX8GC3Ft9vEL_qA4YwuoTeJHBx-H4rA_VmPuilXyCrvrJLzaM_yiWJdOgW8rs-_ErS54TnvXO3w_GLt0uEDk_1krbSlDYKcgWYZl8oi2UOEe209jS2BTZy3QT4k9wVbTPkdf0P_ORX6LuGB3ZAwHihZZwL4w4wFIGeLRBUq0rgi2tk9xfURP2gEXTilgK6tNR2RYND84R9x-bMbR3d6V5etgGrgFrj2MNipW9Bj6kpgFOPhEU4P8zIWDHX-EF5Dk9MjuDhbSGIG8jZpl8JWzmWAiDbPX-IGnHBWZh5VQLmPzB6NeA3BLnqUYFGMRum8g5nbWqEtF1TKd5z8slZJiD6-E_dUtBbrBZ7sR_pq4WMl_GblvlNQ2Q3gffEIPZyxs81lVxdLcVkYyd0Ne7F9S7zX_W_HjInUiEc9btE9Y53jv6c9odzSOkLjnp94epipyuuawcUFWj-I35MPVxiOshNNSLHO1Jhe75-UmrbSrJhd3bliGeGyvilpkviPxrf3fJ4AUQHG0EnnNP9wLNTqYeEKf-k-JivTHD8dhYTVp_iHxcpM9N-nYVxhfqKO9azCkcox8L6skBEqBhtcE9Un6qnCZMgtRI29maghnqNz9xCzllXlkVxRq_Qj0_46uJFGH2nJo03PyTaFFKmRTxkdJWcXIOmVexY7aRIejzlZCvIAhiHVVlGELN5zxUH9nOt1rrzB8P8KCCOG1SgP1InuCv_-ZSBM_ELoYwqpg9WbafeWJCE_5lZULvfpFYE6KAw7S-9JE1Vx0mT_cTZQgERT9hmj2ZA1B93YXQVWMsWa9Kx-t2xVVXXOb_ojemxt0Ey0MxKzlLxGruWn2rQ2FNdPboxwW';
            let FOLDER_PATH = ''; // Default: root folder

            // Validate access token
            if (!ACCESS_TOKEN || ACCESS_TOKEN.includes('\n') || ACCESS_TOKEN.includes('"') || ACCESS_TOKEN.includes(' ')) {
                document.getElementById('auth-message').textContent = 'Error: Invalid Dropbox access token format. Ensure it is a single-line string.';
                console.error('Invalid Dropbox access token format. Ensure ACCESS_TOKEN is a single-line string without quotes, spaces, or line breaks.');
                throw new Error('Invalid Dropbox access token format.');
            }

            const dbx = new Dropbox.Dropbox({ accessToken: ACCESS_TOKEN });
            let images = [];
            let currentIndex = 0;
            let isPlaying = false;
            let slideshowInterval;

            // Validate folder path
            async function validateFolderPath(path) {
                try {
                    const response = await dbx.filesListFolder({ path: path || '' });
                    return { valid: true, entries: response.result.entries };
                } catch (error) {
                    console.error('Folder validation failed:', error);
                    return { valid: false, error };
                }
            }

            // Test API connection
            async function testConnection() {
                try {
                    document.getElementById('connect-button').disabled = true;
                    document.getElementById('auth-message').textContent = 'Connecting to Dropbox...';
                    const response = await dbx.usersGetCurrentAccount();
                    console.log('Connected to Dropbox as:', response.result.name.display_name);
                    document.getElementById('auth-message').textContent = 'Connected to Dropbox!';
                    return true;
                } catch (error) {
                    console.error('Connection test failed:', error);
                    document.getElementById('auth-message').textContent = 'Error: Invalid access token or network issue. Check console for details.';
                    document.getElementById('connect-button').disabled = false;
                    return false;
                }
            }

            // Fisher-Yates shuffle algorithm
            function shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            // Fetch images from Dropbox
            async function fetchImages() {
                try {
                    document.getElementById('auth-message').textContent = 'Loading images...';
                    FOLDER_PATH = document.getElementById('folder-input').value || '';
                    const folderValidation = await validateFolderPath(FOLDER_PATH);
                    if (!folderValidation.valid) {
                        document.getElementById('auth-message').textContent = `Error: Folder "${FOLDER_PATH || 'root'}" does not exist or is inaccessible. Enter a valid folder path.`;
                        console.error('Invalid folder:', folderValidation.error);
                        document.getElementById('connect-button').disabled = false;
                        return;
                    }
                    const response = await dbx.filesListFolder({ path: FOLDER_PATH });
                    const imageEntries = response.result.entries.filter(entry =>
                        entry.name.match(/\.(jpg|jpeg|png|gif|webp)$/i)
                    );
                    if (response.result.entries.length > 0 && imageEntries.length === 0) {
                        console.log('Folder contents:', response.result.entries.map(entry => entry.name));
                        document.getElementById('auth-message').textContent = `No supported images (jpg, jpeg, png, gif, webp) found in "${FOLDER_PATH || 'root'}". Check folder contents in console.`;
                        document.getElementById('connect-button').disabled = false;
                        return;
                    }
                    images = shuffle(imageEntries);
                    if (images.length === 0) {
                        document.getElementById('auth-message').textContent = `No images found in "${FOLDER_PATH || 'root'}". Ensure the folder contains images (jpg, jpeg, png, gif, webp).`;
                        console.log('No images found. Folder contents:', response.result.entries.map(entry => entry.name));
                        document.getElementById('connect-button').disabled = false;
                        return;
                    }
                    // Get temporary links for images
                    for (let entry of images) {
                        const linkResponse = await dbx.filesGetTemporaryLink({ path: entry.path_lower });
                        entry.url = linkResponse.result.link;
                    }
                    document.getElementById('auth-message').style.display = 'none';
                    document.getElementById('play-pause-button').style.display = 'inline-block';
                    document.getElementById('prev-button').style.display = 'inline-block';
                    document.getElementById('next-button').style.display = 'inline-block';
                    document.getElementById('connect-button').style.display = 'none';
                    document.getElementById('folder-input').style.display = 'none';
                    showImage(currentIndex);
                } catch (error) {
                    console.error('Error fetching images:', error);
                    document.getElementById('auth-message').textContent = 'Error loading images. Check folder path, permissions, or console for details.';
                    document.getElementById('connect-button').disabled = false;
                }
            }

            // Display image at given index
            function showImage(index) {
                if (index < 0 || index >= images.length) return;
                currentIndex = index;
                document.getElementById('slideshow-image').src = images[index].url;
                document.getElementById('slideshow-image').style.display = 'block';
            }

            // Start or stop slideshow
            function toggleSlideshow() {
                if (isPlaying) {
                    clearInterval(slideshowInterval);
                    document.getElementById('play-pause-button').textContent = 'Play';
                } else {
                    slideshowInterval = setInterval(() => {
                        currentIndex = (currentIndex + 1) % images.length;
                        showImage(currentIndex);
                    }, 5000); // Change image every 5 seconds
                    document.getElementById('play-pause-button').textContent = 'Pause';
                }
                isPlaying = !isPlaying;
            }

            // Event listeners
            document.getElementById('connect-button').addEventListener('click', async () => {
                const isConnected = await testConnection();
                if (isConnected) fetchImages();
            });
            document.getElementById('play-pause-button').addEventListener('click', toggleSlideshow);
            document.getElementById('prev-button').addEventListener('click', () => {
                currentIndex = (currentIndex - 1 + images.length) % images.length;
                showImage(currentIndex);
            });
            document.getElementById('next-button').addEventListener('click', () => {
                currentIndex = (currentIndex + 1) % images.length;
                showImage(currentIndex);
            });

            // Keyboard navigation
            document.addEventListener('keydown', (event) => {
                if (event.key === 'ArrowLeft') {
                    currentIndex = (currentIndex - 1 + images.length) % images.length;
                    showImage(currentIndex);
                } else if (event.key === 'ArrowRight') {
                    currentIndex = (currentIndex + 1) % images.length;
                    showImage(currentIndex);
                } else if (event.key === ' ') {
                    toggleSlideshow();
                }
            });
        }
    </script>
</body>
</html>